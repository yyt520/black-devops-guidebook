<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link
      rel="stylesheet"
      href="/black-devops-guidebook/docs__server__nginx__configuration-grammar.md.chunk.css"
    />
    <script>
      window.routerBase = "/black-devops-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>配置语法 - DevOps Guidebook</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/server/nginx/configuration-grammar" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/black-devops-guidebook//">DevOps Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-devops-guidebook//linux">Linux</a></span><span><a aria-current="page" class="active" href="/black-devops-guidebook//server">服务器</a></span><span><a href="/black-devops-guidebook//deploy">部署</a></span><span><a href="/black-devops-guidebook//code">代码管理</a></span><span><a href="/black-devops-guidebook//devops">DevOps</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/devops-icon.png&#x27;)" href="/black-devops-guidebook//"></a><h1>DevOps Guidebook</h1><p>DevOps 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-devops-guidebook//linux">Linux</a></li><li><a aria-current="page" class="active" href="/black-devops-guidebook//server">服务器</a></li><li><a href="/black-devops-guidebook//deploy">部署</a></li><li><a href="/black-devops-guidebook//code">代码管理</a></li><li><a href="/black-devops-guidebook//devops">DevOps</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-devops-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">Nginx</a><ul><li><a href="/black-devops-guidebook//server/nginx"><span>基本概要</span></a></li><li><a href="/black-devops-guidebook//server/nginx/install"><span>安装教程</span></a></li><li><a href="/black-devops-guidebook//server/nginx/command-line"><span>命令行指令</span></a></li><li><a aria-current="page" class="active" href="/black-devops-guidebook//server/nginx/configuration-grammar"><span>配置语法</span></a></li><li><a href="/black-devops-guidebook//server/nginx/modules"><span>配置模块</span></a></li><li><a href="/black-devops-guidebook//server/nginx/static-resource-server"><span>静态资源服务器</span></a></li><li><a href="/black-devops-guidebook//server/nginx/proxy-service"><span>代理服务器</span></a></li><li><a href="/black-devops-guidebook//server/nginx/load-balance"><span>负载均衡</span></a></li><li><a href="/black-devops-guidebook//server/nginx/dynamic-cache"><span>动态缓存</span></a></li><li><a href="/black-devops-guidebook//server/nginx/rewrite"><span>地址重定向</span></a></li><li><a href="/black-devops-guidebook//server/nginx/https-service"><span>HTTPS 服务</span></a></li><li><a href="/black-devops-guidebook//server/nginx/log"><span>访问日志</span></a></li><li><a href="/black-devops-guidebook//server/nginx/architect"><span>架构原理</span></a></li><li><a href="/black-devops-guidebook//server/nginx/practical-configuration"><span>实用配置</span></a></li><li><a href="/black-devops-guidebook//server/nginx/best-practice"><span>最佳实践</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">ELK</a><ul><li><a href="/black-devops-guidebook//server/elk"><span>ELK</span></a></li><li><a href="/black-devops-guidebook//server/elk/elasticsearch"><span>Elasticsearch</span></a></li><li><a href="/black-devops-guidebook//server/elk/logstash"><span>Logstash</span></a></li><li><a href="/black-devops-guidebook//server/elk/filebeat"><span>Filebeat</span></a></li><li><a href="/black-devops-guidebook//server/elk/kibana"><span>Kibana</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="配置结构" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#配置结构"><span>配置结构</span></a></li><li title="main 全局块" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#main-全局块"><span>main 全局块</span></a></li><li title="user" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#user"><span>user</span></a></li><li title="pid" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#pid"><span>pid</span></a></li><li title="worker_rlimit_nofile_number" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_rlimit_nofile_number"><span>worker_rlimit_nofile_number</span></a></li><li title="worker_rlimit_core" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_rlimit_core"><span>worker_rlimit_core</span></a></li><li title="worker_processes_number" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_processes_number"><span>worker_processes_number</span></a></li><li title="worker_cpu_affinity" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_cpu_affinity"><span>worker_cpu_affinity</span></a></li><li title="worker_priority" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_priority"><span>worker_priority</span></a></li><li title="worker_shutdown_timeout" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_shutdown_timeout"><span>worker_shutdown_timeout</span></a></li><li title="timer_resolution" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#timer_resolution"><span>timer_resolution</span></a></li><li title="daemon" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#daemon"><span>daemon</span></a></li><li title="events 块" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#events-块"><span>events 块</span></a></li><li title="use" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#use"><span>use</span></a></li><li title="worker_connections" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_connections"><span>worker_connections</span></a></li><li title="accept_mutex" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#accept_mutex"><span>accept_mutex</span></a></li><li title="http 块" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#http-块"><span>http 块</span></a></li><li title="server 块" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#server-块"><span>server 块</span></a></li><li title="server_name" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#server_name"><span>server_name</span></a></li><li title="root" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#root"><span>root</span></a></li><li title="try_files" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#try_files"><span>try_files</span></a></li><li title="location 块" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#location-块"><span>location 块</span></a></li><li title="匹配命令" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#匹配命令"><span>匹配命令</span></a></li><li title="匹配优先级" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#匹配优先级"><span>匹配优先级</span></a></li><li title="反斜线" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#反斜线"><span>反斜线</span></a></li><li title="alias" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#alias"><span>alias</span></a></li><li title="return" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#return"><span>return</span></a></li><li title="rewrite" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#rewrite"><span>rewrite</span></a></li><li title="if 指令" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#if-指令"><span>if 指令</span></a></li><li title="autoindex" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#autoindex"><span>autoindex</span></a></li><li title="变量" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#变量"><span>变量</span></a></li><li title="自定义变量" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#自定义变量"><span>自定义变量</span></a></li><li title="内置预定义变量" data-depth="3"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#内置预定义变量"><span>内置预定义变量</span></a></li><li title="配置文件目录" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#配置文件目录"><span>配置文件目录</span></a></li><li title="参考资料" data-depth="2"><a href="/black-devops-guidebook//server/nginx/configuration-grammar#参考资料"><span>参考资料</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="配置语法"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#配置语法"><span class="icon icon-link"></span></a>配置语法</h1><p>更多更详细的配置请查阅：<a target="_blank" rel="noopener noreferrer" href="http://nginx.org/en/docs/">nginx documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或 <a target="_blank" rel="noopener noreferrer" href="https://www.nginx.cn/doc/">Nginx 中文文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="配置结构"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#配置结构"><span class="icon icon-link"></span></a>配置结构</h2><p>Nginx 配置的核心是定义要处理的 <code>URL</code> 以及如何响应这些 <code>URL</code> 请求，即定义一系列的 <strong>虚拟服务器（Virtual Servers）</strong> 控制对来自特定域名或者 IP 的请求的处理。每一个虚拟服务器定义一系列的 <code>location</code> 控制处理特定的 URI 集合。每一个 <code>location</code> 定义了对映射到自己的请求的处理场景，可以返回一个文件或者代理此请求。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># main 全局块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># Events 块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">events </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># Http 块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 配置使用最频繁的部分，代理、缓存、日志定义等绝大多数功能和第三方模块的配置都在这里设置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">http </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># Server 块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># Location 块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    location </span><span class="token punctuation">[</span><span class="token plain">PATTERN</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    location </span><span class="token punctuation">[</span><span class="token plain">PATTERN</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li><code>main</code>：Nginx 的全局配置，对全局生效</li><li><code>events</code>：配置影响 Nginx 服务器或与用户的网络连接</li><li><code>http</code>：可以嵌套多个 Server，配置代理、缓存、日志定义等绝大多数功能和第三方模块的配置</li><li><code>server</code>：配置虚拟主机的相关参数，一个 HTTP 中可以有多个 <code>server</code> 块</li><li><code>location</code>：用于配置请求的路由，以及各种页面的处理情况</li><li><code>upstream</code>：配置后端服务器具体地址，负载均衡配置不可或缺的部分</li></ul><p>配置文件的语法规则：</p><ul><li>配置文件由指定的指令控制，指令分为 <strong>简单指令</strong> 与 <strong>指令块</strong> 构成</li><li>简单指令包含 <strong>指令名称</strong> 和 <strong>指令参数</strong></li><li>指令与参数间以空格符号分隔，每条指令以 <code>;</code> 分号结尾</li><li>指令块以 <code>{<!-- -->}</code> 大括号将多条指令组织在一起</li><li><code>include</code> 语句允许组合多个配置文件以提升可维护性</li><li>使用 <code>#</code> 符号添加注释，提高可读性</li><li>使用 <code>$</code> 符号使用变量</li><li>部分指令的参数支持正则表达式</li></ul><h2 id="main-全局块"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#main-全局块"><span class="icon icon-link"></span></a>main 全局块</h2><p>该部分配置用于设置影响 Nginx 全局的指令，通常包括以下几个部分：</p><ul><li>配置运行 Nginx 服务器用户（组）</li><li>worker process 数</li><li>Nginx 进程 PID 存放路径</li><li>错误日志的存放路径</li><li>配置文件引入</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 配置运行 Nginx 服务器用户（组）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">user</span><span class="token directive"> root</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 错误日志的存放路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">error_log</span><span class="token directive"> /var/log/nginx/error.log</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># Nginx 进程 PID 存放路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">pid</span><span class="token directive"> /run/nginx.pid</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 设置工作进程数量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_process</span><span class="token directive"> </span><span class="token directive number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 配置文件引入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">include</span><span class="token directive"> /usr/share/nginx/modules/*.conf</span><span class="token punctuation">;</span></div></pre></div><h3 id="user"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#user"><span class="icon icon-link"></span></a>user</h3><p>指定运行 Nginx 的 <code>woker</code> 子进程的属主和属组，其中组可以不指定。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">user</span><span class="token directive"> &lt;USERNAME&gt; [GROUP]</span></div><div class="token-line"><span class="token directive">
</span></div><div class="token-line"><span class="token directive"></span><span class="token directive comment"># 用户是 nginx; 组是 dev</span><span class="token directive"></span></div><div class="token-line"><span class="token directive">user nginx dev</span><span class="token punctuation">;</span></div></pre></div><h3 id="pid"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#pid"><span class="icon icon-link"></span></a>pid</h3><p>指定运行 Nginx <code>master</code> 主进程的 <code>pid</code> 文件存放路径。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># master 主进程的的 pid 存放在 nginx.pid 的文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">pid /opt/nginx/logs/nginx.pid</span></div></pre></div><h3 id="worker_rlimit_nofile_number"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_rlimit_nofile_number"><span class="icon icon-link"></span></a>worker_rlimit_nofile_number</h3><p>指定 <code>worker</code> 子进程可以打开的最大文件句柄数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 可以理解成每个 worker 子进程的最大连接数量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_rlimit_nofile</span><span class="token directive"> </span><span class="token directive number">20480</span><span class="token punctuation">;</span></div></pre></div><h3 id="worker_rlimit_core"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_rlimit_core"><span class="icon icon-link"></span></a>worker_rlimit_core</h3><p>指定 <code>worker</code> 子进程异常终止后的 <code>core</code> 文件，用于记录分析问题。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 存放大小限制</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_rlimit_core</span><span class="token directive"> </span><span class="token directive number">50M</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 存放目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">working_directory</span><span class="token directive"> /opt/nginx/tmp</span><span class="token punctuation">;</span></div></pre></div><h3 id="worker_processes_number"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_processes_number"><span class="icon icon-link"></span></a>worker_processes_number</h3><p>指定 Nginx 启动的 <code>worker</code> 子进程数量。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 指定具体子进程数量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_processes</span><span class="token directive"> </span><span class="token directive number">4</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 与当前cpu物理核心数一致</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_processes</span><span class="token directive"> auto</span><span class="token punctuation">;</span></div></pre></div><h3 id="worker_cpu_affinity"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_cpu_affinity"><span class="icon icon-link"></span></a>worker_cpu_affinity</h3><p>将每个 <code>worker</code> 子进程与我们的 <code>cpu</code> 物理核心绑定。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 4 个物理核心，4 个 worker 子进程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_cpu_affinity</span><span class="token directive"> </span><span class="token directive number">0001</span><span class="token directive"> </span><span class="token directive number">0010</span><span class="token directive"> </span><span class="token directive number">0100</span><span class="token directive"> </span><span class="token directive number">1000</span><span class="token punctuation">;</span></div></pre></div><p>将每个 <code>worker</code> 子进程与特定 CPU 物理核心绑定，优势在于，避免同一个 <code>worker</code> 子进程在不同的 CPU 核心上切换，缓存失效，降低性能。但其并不能真正的避免进程切换。</p><h3 id="worker_priority"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_priority"><span class="icon icon-link"></span></a>worker_priority</h3><p>指定 <code>worker</code> 子进程的 <code>nice</code> 值，以调整运行 Nginx 的优先级，通常设定为负值，以优先调用 Nginx。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 120-10=110，110 就是最终的优先级</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_priority</span><span class="token directive"> -10</span><span class="token punctuation">;</span></div></pre></div><p>Linux 默认进程的优先级值是 120，值越小越优先； <code>nice</code> 定范围为 <code>-20</code> 到 <code>+19</code> 。</p><p><strong>备注</strong>：应用的默认优先级值是 120 加上 <code>nice</code> 值等于它最终的值，这个值越小，优先级越高。</p><h3 id="worker_shutdown_timeout"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_shutdown_timeout"><span class="icon icon-link"></span></a>worker_shutdown_timeout</h3><p>指定 <code>worker</code> 子进程优雅退出时的超时时间。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">worker_shutdown_timeout</span><span class="token directive"> </span><span class="token directive number">5s</span><span class="token punctuation">;</span></div></pre></div><h3 id="timer_resolution"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#timer_resolution"><span class="icon icon-link"></span></a>timer_resolution</h3><p><code>worker</code> 子进程内部使用的计时器精度，调整时间间隔越大，系统调用越少，有利于性能提升；反之，系统调用越多，性能下降。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">timer_resolution</span><span class="token directive"> </span><span class="token directive number">100ms</span><span class="token punctuation">;</span></div></pre></div><p>在 Linux 系统中，用户需要获取计时器时需要向操作系统内核发送请求，有请求就必然会有开销，因此这个间隔越大开销就越小。</p><h3 id="daemon"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#daemon"><span class="icon icon-link"></span></a>daemon</h3><p>指定 Nginx 的运行方式，前台还是后台，前台用于调试，后台用于生产。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 默认是 on，后台运行模式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">daemon</span><span class="token directive"> </span><span class="token directive boolean">off</span><span class="token punctuation">;</span></div></pre></div><h2 id="events-块"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#events-块"><span class="icon icon-link"></span></a>events 块</h2><p><code>events</code> 块配置影响 Nginx 服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</p><p>该部分配置主要影响 Nginx 服务器与用户的网络连接，主要包括：</p><ul><li>设置网络连接的序列化</li><li>是否允许同时接收多个网络连接</li><li>事件驱动模型的选择</li><li>最大连接数的配置</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 处理连接</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">events</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 默认使用的网络 I/O 模型，Linux 系统推荐采用 epoll 模型，FreeBSD 推荐采用 kqueue 模型</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># use epoll;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 设置连接数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">worker_connections:</span><span class="token directive"> </span><span class="token directive number">1024</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="use"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#use"><span class="icon icon-link"></span></a>use</h3><p>Nginx 使用何种事件驱动模型。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 不推荐配置它，让 Nginx 自己选择</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">use</span><span class="token directive"> &lt;method&gt;</span><span class="token punctuation">;</span></div></pre></div><p><code>method</code> 的可选值：</p><ul><li><code>select</code></li><li><code>poll</code></li><li><code>kqueue</code></li><li><code>epoll</code></li><li><code>/dev/poll</code></li><li><code>eventport</code></li></ul><h3 id="worker_connections"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#worker_connections"><span class="icon icon-link"></span></a>worker_connections</h3><p><code>worker</code> 子进程能够处理的最大并发连接数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 每个子进程的最大连接数为1024</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">worker_connections</span><span class="token directive"> </span><span class="token directive number">1024</span><span class="token punctuation">;</span></div></pre></div><h3 id="accept_mutex"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#accept_mutex"><span class="icon icon-link"></span></a>accept_mutex</h3><p>是否打开负载均衡互斥锁。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 默认是 off 关闭的，这里推荐打开</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">accept_mutex</span><span class="token directive"> </span><span class="token directive boolean">on</span><span class="token punctuation">;</span></div></pre></div><h2 id="http-块"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#http-块"><span class="icon icon-link"></span></a>http 块</h2><p><code>http</code> 块可以嵌套多个 <code>server</code>，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，<code>mime-type</code> 定义，日志自定义，是否使用 <code>sendfile</code> 传输文件，连接超时时间，单连接请求数等。</p><ul><li>定义 MIMI-Type</li><li>自定义服务日志</li><li>允许 sendfile 方式传输文件</li><li>连接超时时间</li><li>单连接请求数上限</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">http</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 文件拓展名查找集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">include</span><span class="token directive">   mime.types</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 当查找不到对应类型的时候默认值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">default_type</span><span class="token directive">    application/octet-stream</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 日志格式，定义别名为 main</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">log_format</span><span class="token directive"> main </span><span class="token directive string">&#x27;</span><span class="token directive string variable">$remote_addr</span><span class="token directive string"> - </span><span class="token directive string variable">$remote_user</span><span class="token directive string"> [</span><span class="token directive string variable">$time_local]</span><span class="token directive string"> &quot;</span><span class="token directive string variable">$request</span><span class="token directive string">&quot; &#x27;</span><span class="token directive"></span></div><div class="token-line"><span class="token directive">                  </span><span class="token directive string">&#x27;</span><span class="token directive string variable">$status</span><span class="token directive string"> </span><span class="token directive string variable">$body_bytes_sent</span><span class="token directive string"> &quot;</span><span class="token directive string variable">$http_referer</span><span class="token directive string">&quot; &#x27;</span><span class="token directive"></span></div><div class="token-line"><span class="token directive">                  </span><span class="token directive string">&#x27;&quot;</span><span class="token directive string variable">$http_user_agent</span><span class="token directive string">&quot; &quot;</span><span class="token directive string variable">$http_x</span><span class="token directive string">&quot;_forwarded_for&quot;&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 指定日志输入目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">access_log</span><span class="token directive"> logs/access.log main</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 调用 sendfile 系统传输文件，开启高效传输模式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># sendfile 开启的情况下，提高网络包的传输效率（等待，一次传输）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">sendfile</span><span class="token directive">      </span><span class="token directive boolean">on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 减少网络报文段的数量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">tcp_nopush</span><span class="token directive">    </span><span class="token directive boolean">on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 客户端与服务器连接超时时间，超时自动断开</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># keepalive_timeout   0;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">keepalive_timeout</span><span class="token directive">     </span><span class="token directive number">65</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 开启 Gzip 压缩</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">gzip</span><span class="token directive">    </span><span class="token directive boolean">on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># proxy_cache_path /nginx/cache levels=1:2 keys_zone=mycache:16m inactive=24h max_size=1g</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 当存在多个域名的时候，如果所有配置都写在 nginx.conf 主配置文件中，难免显得杂乱无章</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 为了方便维护，可以进行拆分配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">include</span><span class="token directive"> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 虚拟主机</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 省略，详细配置看 server 块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 位置路由，详细配置看 location 块</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 引入其他的配置文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">include</span><span class="token directive"> servers/*</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="server-块"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#server-块"><span class="icon icon-link"></span></a>server 块</h2><p><code>server</code> 块：配置虚拟主机的相关参数，一个 <code>http</code> 中可以有多个 <code>server</code>。</p><ul><li>配置网络监听</li><li>基于名称的虚拟主机配置</li><li>基于 IP 的虚拟主机配置</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 虚拟主机</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">          </span><span class="token directive number">8080</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 浏览器访问域名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">     domain.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">charset</span><span class="token directive"> utf-8</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">access_log</span><span class="token directive">  logs/domain.access.log  access</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 路由</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 访问根目录</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">root</span><span class="token directive">    www</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 入口文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive">   index.html index.htm</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="server_name"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#server_name"><span class="icon icon-link"></span></a>server_name</h3><p>指定虚拟主机域名。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server_name</span><span class="token directive"> &lt;name1&gt; &lt;name2&gt; &lt;name3&gt; ...</span></div><div class="token-line"><span class="token directive">
</span></div><div class="token-line"><span class="token directive"></span><span class="token directive comment"># 示例：</span><span class="token directive"></span></div><div class="token-line"><span class="token directive">server_name www.nginx.com</span><span class="token punctuation">;</span></div></pre></div><p>域名匹配的四种写法：</p><ul><li>精确匹配：<code>server_name www.nginx.com</code></li><li>左侧通配：<code>server_name *.nginx.com</code></li><li>右侧通配：<code>server_name www.nginx.*</code></li><li>正则匹配：<code>server_name ~^www\.nginx\.*$</code></li></ul><p>匹配优先级： <strong>精准匹配</strong> &gt; <strong>左侧通配符匹配</strong> &gt; <strong>右侧通配符匹配</strong> &gt; <strong>正则表达式匹配</strong></p><p><code>server_name</code> 配置实例：</p><ol><li>配置本地 DNS 解析 <code>vim /etc/hosts</code>（macOS 系统）</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 添加如下内容，其中 121.42.11.34 是云服务器的 IP 地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token number">121.42</span><span class="token plain">.11.34 www.nginx-test.com</span></div><div class="token-line"><span class="token plain"></span><span class="token number">121.42</span><span class="token plain">.11.34 mail.nginx-test.com</span></div><div class="token-line"><span class="token plain"></span><span class="token number">121.42</span><span class="token plain">.11.34 www.nginx-test.org</span></div><div class="token-line"><span class="token plain"></span><span class="token number">121.42</span><span class="token plain">.11.34 doc.nginx-test.com</span></div><div class="token-line"><span class="token plain"></span><span class="token number">121.42</span><span class="token plain">.11.34 www.nginx-test.cn</span></div><div class="token-line"><span class="token plain"></span><span class="token number">121.42</span><span class="token plain">.11.34 fe.nginx-test.club</span></div></pre></div><p><strong>注意</strong>：这里使用的是虚拟域名进行测试，因此需要配置本地 DNS 解析，如果使用云服务提供商（例如阿里云）上购买的域名，则需要在云服务提供商上设置好域名解析。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 这里只列举了 http 端中的 sever 端配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 左匹配</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">         </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">    *.nginx-test.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive">           /usr/share/nginx/html/nginx-test/left-match/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive"> index.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 正则匹配</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">         </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">    ~^.*\.nginx-test\..*$</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive">          /usr/share/nginx/html/nginx-test/reg-match/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive"> index.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 右匹配</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">        </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">   www.nginx-test.*</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive">          /usr/share/nginx/html/nginx-test/right-match/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive"> index.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 完全匹配</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">        </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">   www.nginx-test.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive">          /usr/share/nginx/html/nginx-test/all-match/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive"> index.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ol start="3"><li>访问分析</li></ol><ul><li>当访问 <code>www.nginx-test.com</code> 时，都可以被匹配上，因此选择优先级最高的完全匹配</li><li>当访问 <code>mail.nginx-test.com</code> 时，会进行左匹配</li><li>当访问 <code>www.nginx-test.org</code> 时，会进行右匹配</li><li>当访问 <code>doc.nginx-test.com</code> 时，会进行左匹配</li><li>当访问 <code>www.nginx-test.cn</code> 时，会进行右匹配</li><li>当访问 <code>fe.nginx-test.club</code> 时，会进行正则匹配</li></ul><h3 id="root"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#root"><span class="icon icon-link"></span></a>root</h3><p>指定静态资源目录位置，它可以写在 <code>http</code>、<code>servr</code>、<code>location</code> 块等配置中。</p><p><code>root</code> 与 <code>alias</code> 的区别主要在于 Nginx 如何解释 <code>location</code> 后面的路径的 URI，这会使两者分别以不同的方式将请求映射到服务器文件上。具体来看：</p><ul><li><code>root</code> 的处理结果是：<code>root</code> 路径 + <code>location</code> 路径</li><li><code>alias</code> 的处理结果是：使用 <code>alias</code> 路径替换 <code>location</code> 路径</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">root</span><span class="token directive"> path</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 例如</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">location</span><span class="token directive"> /image</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive"> /opt/nginx/static</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>当用户访问 <code>www.test.com/image/1.png</code> 时，实际在服务器找的路径是 <code>/opt/nginx/static/image/1.png</code>。</p><p>另一个例子：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">        </span><span class="token directive number">9001</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">   localhost</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /hello</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">root</span><span class="token directive">        /usr/local/var/www</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>在请求 <code>http://localhost:9001/hello</code> 时，服务器返回的路径地址应该是 <code>/usr/local/var/www/hello/index.html</code>。</p><p><strong>注意</strong>：<code>root</code> 会将定义路径与 <code>URI</code> 叠加，<code>alias</code> 则只取定义路径。</p><h3 id="try_files"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#try_files"><span class="icon icon-link"></span></a>try_files</h3><p><code>try_files</code> 的作用就是在匹配 location 的路径时，如果没有匹配到对应的路径的话，提供一个回退的方案。</p><p>工作原理：按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。</p><p>需要注意的是，只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部 URI 的指向。最后一个参数是回退 URI 且必须存在，否则会出现内部 500 错误。命名的 <code>location</code> 也可以使用在最后一个参数中。</p><p>示例一：</p><div class="__dumi-default-code-block"><pre class="prism-code language-ngix"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">locaton / {</span></div><div class="token-line"><span class="token plain">  try_files /app/cache/ $uri @fallback;</span></div><div class="token-line"><span class="token plain">  index index.php index.html;</span></div><div class="token-line"><span class="token plain">}</span></div></pre></div><p>它将检测 <code>$document_root/app/cache/index.php</code>、<code>$document_root/app/cache/index.html</code> 和 <code>$document_root$uri</code> 是否存在，如果不存在将内部重定向到 <code>@fallback</code>（<code>@</code> 表示配置文件中预定义标记点）。</p><p>你也可以使用一个文件或者状态码（<code>=404</code>）作为最后一个参数，如果是最后一个参数是文件，那么这个文件必须存在。</p><p>在非根路径下使用 <code>try_files</code>，当我们希望在 <code>/test</code> 路径下部署一个路由使用 History 的 Vue 应用，那么可以使用如下的 Nginx 配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">            </span><span class="token directive number">9001</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive">       localhost</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /test</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">root</span><span class="token directive">            /usr/local/var/www/hello/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive">           index.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">try_files</span><span class="token directive">       </span><span class="token directive variable">$uri</span><span class="token directive"> </span><span class="token directive variable">$uri</span><span class="token directive">/ /test/index.html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>这个时候：</p><ul><li>当 <code>/test</code> 路径下的请求，不会收到上面的配置影响</li><li>当访问 <code>/test</code> 时，会使用 <code>root</code> 的匹配规则，到服务器 <code>/usr/local/var/www/hello/test</code> 路径下寻找 <code>index.html</code> 文件</li><li>当访问 <code>/test/demo1</code> 时，会使用 <code>try_files</code> 的匹配规则，到 <code>root</code> 路径下去寻找最后一个参数 <code>/test/index.html</code> 的回退方案，也就是说去 <code>/usr/local/var/www/hello/test</code> 路径下寻找 <code>index.html</code> 文件</li></ul><h2 id="location-块"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#location-块"><span class="icon icon-link"></span></a>location 块</h2><p><code>location</code> 块：配置请求的路由，以及各种页面的处理情况。</p><ul><li>location 配置</li><li>请求根目录配置</li><li>更改 location 的 URI</li><li>网站默认首页配置</li></ul><h3 id="匹配命令"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#匹配命令"><span class="icon icon-link"></span></a>匹配命令</h3><p>不同模块指令关系：<code>server</code> 继承 <code>main</code>；<code>location</code> 继承 <code>server</code>；<code>upstream</code> 既不会继承指令也不会被继承，它有自己的特殊指令，不需要在其他地方的应用</p><p>Nginx 的路径分类：</p><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th align="left">参数</th><th align="left">名称</th><th align="left">说明</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left">空</td><td align="left">普通前端匹配的路径</td><td align="left">location 后没有参数直接跟着 <strong>标准 URI</strong>，表示前缀匹配，代表跟请求中的 URI 从头开始匹配。</td><td align="left"><code>location / <!-- -->{<!-- -->}</code></td></tr><tr><td align="left"><code>=</code></td><td align="left">精确匹配的路径</td><td align="left">用于<strong>标准 URI</strong> 前，要求请求字符串与其精准匹配，成功则立即处理，nginx 停止搜索其他匹配。</td><td align="left"><code>location ^~ / <!-- -->{<!-- -->}</code></td></tr><tr><td align="left"><code>^~</code></td><td align="left">抢占式前缀匹配的路径</td><td align="left">用于<strong>标准 URI</strong> 前，并要求一旦匹配到就会立即处理，不再去匹配其他的那些个正则 URI，一般用来匹配目录</td><td align="left"><code>location = / <!-- -->{<!-- -->}</code></td></tr><tr><td align="left"><code>~</code></td><td align="left">正则匹配</td><td align="left">用于<strong>正则 URI</strong> 前，表示 URI 包含正则表达式， <strong>区分</strong>大小写</td><td align="left"><code>location @a <!-- -->{<!-- -->}</code></td></tr><tr><td align="left"><code>~*</code></td><td align="left">正则匹配</td><td align="left">用于<strong>正则 URI</strong> 前， 表示 URI 包含正则表达式， <strong>不区分</strong>大小写</td><td align="left"></td></tr><tr><td align="left"><code>@</code></td><td align="left">命名路径</td><td align="left">@ 定义一个命名的 location，@ 定义的 locaiton 名字一般用在内部定向，例如 error_page, try_files 命令中。它的功能类似于编程中的 goto。</td><td align="left"></td></tr></tbody></table></div></div><p>实例配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive">  </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive"> www.nginx-test.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 只有当访问 www.nginx-test.com/match_all/ 时才会匹配到/usr/share/nginx/html/match_all/index.html</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> = /match_all/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root  /usr/share/nginx/html</span></div><div class="token-line"><span class="token plain">      index index.html</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 当访问 www.nginx-test.com/1.jpg 等路径时会去 /usr/share/nginx/images/1.jpg 找对应的资源</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> ~ \.(jpeg|jpg|png|svg)$</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">root</span><span class="token directive"> /usr/share/nginx/images</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 当访问 www.nginx-test.com/bbs/ 时会匹配上 /usr/share/nginx/html/bbs/index.html</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> ^~ /bbs/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">root</span><span class="token directive"> /usr/share/nginx/html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">index</span><span class="token directive"> index.html index.htm</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="匹配优先级"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#匹配优先级"><span class="icon icon-link"></span></a>匹配优先级</h3><p>Nginx <code>location</code> 的大致匹配顺序：</p><ul><li>精确匹配的路径和两类前缀匹配的路径（字母序，如果某个精确匹配的路径的名字和前缀匹配的路径相同，精确匹配的路径排在前面）</li><li>正则路径（出现序）</li><li>命名路径（字母序）</li><li>无名路径（出现序）</li></ul><h3 id="反斜线"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#反斜线"><span class="icon icon-link"></span></a>反斜线</h3><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">location</span><span class="token directive"> /test</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ...</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">location</span><span class="token directive"> /test/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ...</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>不带 <code>/</code> 当访问 <code>www.nginx-test.com/test</code> 时，Nginx 先找是否有 <code>test</code> 目录，如果有则找 <code>test</code> 目录下的 <code>index.html</code>；如果没有 <code>test</code> 目录，Nginx 则会找是否有 <code>test</code> 文件</li><li>带 <code>/</code> 当访问 <code>www.nginx-test.com/test</code> 时，Nginx 先找是否有 <code>test</code> 目录，如果有则找 <code>test</code> 目录下的 <code>index.html</code>；如果没有它也不会去找是否存在 <code>test</code> 文件</li></ul><h3 id="alias"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#alias"><span class="icon icon-link"></span></a>alias</h3><p>它也是指定静态资源目录位置，它只能写在 <code>location</code> 中。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">location</span><span class="token directive"> /image</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">alias</span><span class="token directive"> /opt/nginx/static/image/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>当用户访问 <code>www.test.com/image/1.png</code> 时，实际在服务器找的路径是 <code>/opt/nginx/static/image/1.png</code>。</p><p><strong>注意</strong>：使用 <code>alias</code> 末尾一定要添加 <code>/</code>，并且它只能位于 <code>location</code> 中。</p><h3 id="return"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#return"><span class="icon icon-link"></span></a>return</h3><p>停止处理请求，直接返回响应码或重定向到其他 URL；执行 <code>return</code> 指令后，<code>location</code> 中后续指令讲不会被执行。</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">return</span><span class="token directive"> code [text]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">return</span><span class="token directive"> code URL</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">return</span><span class="token directive"> URL</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 例如</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 直接返回状态码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">return</span><span class="token directive"> </span><span class="token directive number">404</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 返回状态码 + 一段文本</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">return</span><span class="token directive"> </span><span class="token directive number">404</span><span class="token directive"> </span><span class="token directive string">&#x27;page not found&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 返回状态码 + 重定向地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">return</span><span class="token directive"> </span><span class="token directive number">302</span><span class="token directive"> /bbs</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 返回重定向地址</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">return</span><span class="token directive"> https://www.baidu.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="rewrite"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#rewrite"><span class="icon icon-link"></span></a>rewrite</h3><p>根据指定正则表达式匹配规则，重写 <code>URL</code>。</p><p>仅可在 <code>servr</code>、<code>location</code> 或 <code>if</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 语法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">rewrite</span><span class="token directive"> &lt;regexp&gt; &lt;content&gt; [flag]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># $1 是前面括号(.*\.jpg)的反向引用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">rewirte</span><span class="token directive"> /images/(.*\.jpg)$ /pic/</span><span class="token directive variable">$1</span><span class="token punctuation">;</span></div></pre></div><p><code>flag</code> 可选值的含义：</p><ul><li><code>last</code>：重写后的 <code>URL</code> 发起新请求，再次进入 <code>server</code> 段，重试 <code>location</code> 中的匹配</li><li><code>break</code>：直接使用冲邂逅的 <code>URL</code>，不再匹配其他 <code>location</code> 中语句</li><li><code>redirect</code>：返回 302 临时重定向</li><li><code>permanent</code>：返回 301 永久重定向</li></ul><p>实例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive"> </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 要在本地 hosts 文件进行配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive"> mrsingsing.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive"> html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /search</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">rewrite</span><span class="token directive"> ^/(.*) https://www.google.com redirect</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /images</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">r</span><span class="token directive"> ewrite /images/(.*) /pics/</span><span class="token directive variable">$1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /pics</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">rewrite</span><span class="token directive"> /pics/(.*) /photos/</span><span class="token directive variable">$1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /photos</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>按照这个配置我们来分析：</p><ul><li>当访问 <code>fe.mrsingsing.club/search</code> 时，会自动帮我们重定向到 <code>https://www.google.com</code></li><li>当访问 <code>fe.mrsingsing.club/images/1.jpg</code> 时，第一步重写 <code>URL</code> 为 <code>fe.mrsingsing.club/pics/1.jpg</code>，找到 <code>pics</code> 的 <code>location</code>，继续重写 <code>URL</code> 为 <code>fe.mrsingsing.club/photos/1.jpg</code>，找到 <code>/photos</code> 的 <code>location</code> 后，去 <code>html/photos</code> 目录下寻找 <code>1.jpg</code> 静态资源</li></ul><h3 id="if-指令"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#if-指令"><span class="icon icon-link"></span></a>if 指令</h3><p><code>if</code> 指令仅存在于 <code>server</code> 和 <code>location</code> 块中</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 语法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">if</span><span class="token directive"> (condition)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 示例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token directive keyword">if($http_user_agent</span><span class="token directive"> ~ Chrome)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">rewrite</span><span class="token directive"> /(.*)/browser/</span><span class="token directive variable">$1</span><span class="token directive"> break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p><code>condition</code> 判断条件：</p><ul><li><code>$variable</code> 仅为变量时，值为空或以 0 开头字符串都会被当做 <code>false</code> 处理</li><li><code>=</code> 或 <code>!=</code> 相等或不等</li><li><code>~</code> 正则匹配</li><li><code>!~</code> 非正则匹配</li><li><code>~*</code> 正则匹配，不区分大小写</li><li><code>-f</code> 或 <code>! -f</code> 检测文件存在或不存在</li><li><code>-d</code> 或 <code>! -d</code> 检测目录存在或不存在</li><li><code>-e</code> 或 <code>! -e</code> 检测文件、目录、符号链接等存在或不存在</li><li><code>-x</code> 或 <code>! -x</code> 检测文件可以执行或不可执行</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive"> </span><span class="token directive number">8080</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive"> localhost</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">root</span><span class="token directive"> html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">if</span><span class="token directive"> ( </span><span class="token directive variable">$uri</span><span class="token directive"> = </span><span class="token directive string">&quot;/images/&quot;</span><span class="token directive"> )</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token directive keyword">rewrite</span><span class="token directive"> (.*) /pics/ break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>当访问 <code>localhost:8080/images/</code> 时，会进入 <code>if</code> 判断里面执行 <code>rewrite</code> 命令。</p><h3 id="autoindex"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#autoindex"><span class="icon icon-link"></span></a>autoindex</h3><p>用户请求以 <code>/</code> 结尾时，列出目录结构，可以用于快速搭建静态资源下载网站。</p><p>配置实例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">server</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">listen</span><span class="token directive"> </span><span class="token directive number">80</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">server_name</span><span class="token directive"> mrsingsing.com</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token directive keyword">location</span><span class="token directive"> /download/</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">root</span><span class="token directive"> /opt/source</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 打开 autoindex，，可选参数有 on | off</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">autoindex</span><span class="token directive"> </span><span class="token directive boolean">on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 修改为 off，以KB、MB、GB 显示文件大小，默认为 on，以 bytes 显示出⽂件的确切⼤⼩</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">autoindex_exact_size</span><span class="token directive"> </span><span class="token directive boolean">on</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 以 html 的方式进行格式化，可选参数有 html | json | xml</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">autoindex_format</span><span class="token directive"> html</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 显示的⽂件时间为⽂件的服务器时间。默认为 off，显示的⽂件时间为 GMT 时间</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token directive keyword">autoindex_localtime</span><span class="token directive"> </span><span class="token directive boolean">off</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>当访问 mrsingsing.com/download/ 时，会把服务器 /opt/source/download/ 路径下的文件展示出来。</p><h2 id="变量"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#变量"><span class="icon icon-link"></span></a>变量</h2><p>Nginx 可以使用变量简化配置与提高配置的灵活性，所有的变量值都可以通过这种方式引用：</p><ul><li>自定义变量</li><li>内置预定义变量</li></ul><h3 id="自定义变量"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#自定义变量"><span class="icon icon-link"></span></a>自定义变量</h3><p>可以在 <code>server</code>、<code>http</code>、<code>location</code> 等标签中使用 <code>set</code> 命令（非唯一）声明变量，语法如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-nginx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token directive keyword">set</span><span class="token directive"> </span><span class="token directive variable">$variable</span><span class="token directive"> value</span><span class="token punctuation">;</span></div></pre></div><p>注意 Nginx 中的变量必须都以 <code>$</code> 开头。</p><h3 id="内置预定义变量"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#内置预定义变量"><span class="icon icon-link"></span></a>内置预定义变量</h3><p>列出常用的 Nginx 内置变量：</p><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th align="left">变量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>$args</code></td><td align="left">这个变量等于 <code>GET</code> 请求中的所有参数,所以是复数带有 s。例如，<code>foo=123&amp;bar=blahblah;</code> 这个变量只可以被修改</td></tr><tr><td align="left"><code>$arg_param</code></td><td align="left">获取 <code>GET</code> 请求中 <code>param</code> 参数的值。如 <code>/index.html?order=111</code>, 则 <code>$arg_order=111</code></td></tr><tr><td align="left"><code>$binary_remote_addr</code></td><td align="left">二进制码形式的客户端地址</td></tr><tr><td align="left"><code>$body_bytes_sent</code></td><td align="left">已发送的消息体字节数</td></tr><tr><td align="left"><code>$content_length</code></td><td align="left">HTTP 请求信息里的 <code>Content-Length</code></td></tr><tr><td align="left"><code>$content_type</code></td><td align="left">请求信息里的 <code>Content-Type</code></td></tr><tr><td align="left"><code>$document_root</code></td><td align="left">针对当前请求的根路径设置值</td></tr><tr><td align="left"><code>$document_uri</code></td><td align="left">与 <code>$uri</code> 相同</td></tr><tr><td align="left"><code>$host</code></td><td align="left">请求信息中的 <code>Host</code>，如果请求中没有 <code>Host</code> 行，则等于设置的服务器名;</td></tr><tr><td align="left"><code>$http_cookie</code></td><td align="left">Cookie 信息</td></tr><tr><td align="left"><code>$http_referer</code></td><td align="left">来源地址</td></tr><tr><td align="left"><code>$http_user_agent</code></td><td align="left">客户端代理信息</td></tr><tr><td align="left"><code>$http_via</code></td><td align="left">最后一个访问服务器的 IP 地址</td></tr><tr><td align="left"><code>$http_x_forwarded_for</code></td><td align="left">相当于网络访问路径。</td></tr><tr><td align="left"><code>$limit_rate</code></td><td align="left">对连接速率的限制</td></tr><tr><td align="left"><code>$remote_addr</code></td><td align="left">客户端 <code>IP</code> 地址</td></tr><tr><td align="left"><code>$remote_port</code></td><td align="left">客户端端口号</td></tr><tr><td align="left"><code>$remote_user</code></td><td align="left">客户端用户名，认证用</td></tr><tr><td align="left"><code>$request</code></td><td align="left">用户请求信息</td></tr><tr><td align="left"><code>$request_body</code></td><td align="left">用户请求主体</td></tr><tr><td align="left"><code>$request_body_file</code></td><td align="left">发往后端的本地文件名称</td></tr><tr><td align="left"><code>$request_filename</code></td><td align="left">当前请求的文件路径名</td></tr><tr><td align="left"><code>$request_method</code></td><td align="left">请求的方法，比如 <code>GET</code>、<code>POST</code> 等</td></tr><tr><td align="left"><code>$request_uri</code></td><td align="left">请求的 URI，带参数</td></tr><tr><td align="left"><code>$server_addr</code></td><td align="left">服务器地址，如果没有用 listen 指明服务器地址，使用这个变量将发起一次系统调用以取得地址(造成资源浪费)</td></tr><tr><td align="left"><code>$server_name</code></td><td align="left">请求到达的服务器名</td></tr><tr><td align="left"><code>$server_port</code></td><td align="left">请求到达的服务器端口号</td></tr><tr><td align="left"><code>$server_protocol</code></td><td align="left">请求的协议版本，<code>HTTP/1.0</code> 或 <code>HTTP/1.1</code></td></tr><tr><td align="left"><code>$uri</code></td><td align="left">请求的 URI，可能和最初的值有不同，比如经过重定向之类的</td></tr></tbody></table></div></div><h2 id="配置文件目录"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#配置文件目录"><span class="icon icon-link"></span></a>配置文件目录</h2><ul><li>执行目录 <code>/usr/local/nginx/sbin/nginx</code></li><li>模块所在目录 <code>/usr/lib64/nginx/modules</code></li><li>配置所在目录 <code>/etc/nginx</code></li><li>主要配置文件 <code>/etc/nginx/nginx.conf</code> 指向 <code>/etc/nginx/conf.d/default.conf</code></li><li>默认站点目录 <code>/usr/share/nginx/html</code></li></ul><h2 id="参考资料"><a aria-hidden="true" tabindex="-1" href="/black-devops-guidebook//server/nginx/configuration-grammar#参考资料"><span class="icon icon-link"></span></a>参考资料</h2><ul><li><a target="_blank" rel="noopener noreferrer" href="http://nginx.org/en/docs/varindex.html">📖 Nginx Documentation: Alphabetical index of variables<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://mp.weixin.qq.com/s/1Y-B5HdOB2N8z27X-mWc7w">📝 Nginx 快速入门配置篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000022315733">📝 一文厘清 Nginx 中的 location 配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000022407797">📝 一文厘清 Nginx 中的 rewrite 配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.jiangexing.cn/355.html">📝 Nginx 访问日志切割的三种方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.cnblogs.com/zhengchunyuan/p/11281568.html">📝 Nginx 的 try_files 指令使用实例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-devops-guidebook/edit/master/docs/server/nginx/configuration-grammar.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 18:24:22</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-devops-guidebook/umi.js"></script>
    <script src="/black-devops-guidebook/docs__server__nginx__configuration-grammar.md.js"></script>
  </body>
</html>
