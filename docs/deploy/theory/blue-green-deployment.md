# 蓝绿部署

过去的 10 年里，很多公司都在使用蓝绿部署（发布）来实现热部署，这种部署方式具有安全、可靠的特点。蓝绿部署虽然算不上“ Sliver Bullet”，但确实很实用。
蓝绿部署是最常见的一种 0 downtime 部署的方式，是一种以可预测的方式发布应用的技术，目的是减少发布过程中服务停止的时间。蓝绿部署原理上很简单，就是通过冗余来解决问题。通常生产环境需要两组配置（蓝绿配置），一组是 active 的生产环境的配置（绿配置），一组是 inactive 的配置（蓝绿配置）。用户访问的时候，只会让用户访问 active 的服务器集群。在绿色环境（active）运行当前生产环境中的应用，也就是旧版本应用 version1。当你想要升级到 version2 ，在蓝色环境（inactive）中进行操作，即部署新版本应用，并进行测试。如果测试没问题，就可以把负载均衡器／反向代理／路由指向蓝色环境了。随后需要监测新版本应用，也就是 version2 是否有故障和异常。如果运行良好，就可以删除 version1 使用的资源。如果运行出现了问题，可以通过负载均衡器指向快速回滚到绿色环境。

蓝绿部署的优点：

这种方式的好处在你可以始终很放心的去部署 inactive 环境，如果出错并不影响生产环境的服务，如果切换后出现问题，也可以在非常短的时间内把再做一次切换，就完成了回滚。而且同时在线的只有一个版本。蓝绿部署无需停机，并且风险较小。
(1) 部署版本 1 的应用（一开始的状态），所有外部请求的流量都打到这个版本上。
(2) 部署版本 2 的应用，版本 2 的代码与版本 1 不同(新功能、Bug 修复等)。
(3) 将流量从版本 1 切换到版本 2。
(4) 如版本 2 测试正常，就删除版本 1 正在使用的资源（例如实例），从此正式用版本 2。
从过程不难发现，在部署的过程中，应用始终在线。并且，新版本上线的过程中，并没有修改老版本的任何内容，在部署期间，老版本的状态不受影响。这样风险很小，并且，只要老版本的资源不被删除，理论上，可以在任何时间回滚到老版本。

蓝绿部署的弱点：

使用蓝绿部署需要注意的一些细节包括：

1、当切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。如果数据库后端无法处理，会是一个比较麻烦的问题。
2、有可能会出现需要同时处理“微服务架构应用”和“传统架构应用”的情况，如果在蓝绿部署中协调不好这两者，还是有可能导致服务停止；
3、需要提前考虑数据库与应用部署同步迁移/回滚的问题。
4、蓝绿部署需要有基础设施支持。
5、在非隔离基础架构（ VM 、 Docker 等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险。
6、另外，这种方式不好的地方还在于冗余产生的额外维护、配置的成本，以及服务器本身运行的开销。

蓝绿部署适用的场景：

1、不停止老版本，额外搞一套新版本，等测试发现新版本 OK 后，删除老版本。
2、蓝绿发布是一种用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。
3、蓝绿发布对于增量升级有比较好的支持，但是对于涉及数据表结构变更等等不可逆转的升级，并不完全合适用蓝绿发布来实现，需要结合一些业务的逻辑以及数据迁移与回滚的策略才可以完全满足需求。

---

**参考资料：**

- [什么是蓝绿部署？](https://juejin.im/post/5af80f816fb9a07abb23b1b7)
